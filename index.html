<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="Michael Nitschinger, Oliver Gierke, Simon BaslÃ©, Michael Reiche">
<title>Spring Data Couchbase - Reference Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Spring Data Couchbase - Reference Documentation</h1>
<div class="details">
<span id="author" class="author">Michael Nitschinger, Oliver Gierke, Simon BaslÃ©, Michael Reiche</span><br>
<span id="revnumber">version {version},</span>
<span id="revdate">2022-07-25</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; 2014-2022 The original author(s).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.
</td>
</tr>
</table>
</div>
<!-- toc disabled -->
</div>
</div>
<h1 id="couchbase.preface" class="sect0">Preface</h1>
<div class="paragraph">
<p>This reference documentation describes the general usage of the Spring Data Couchbase library.</p>
</div>
<div class="sect1">
<h2 id="metadata">Project Information</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Version control - <a href="https://github.com/spring-projects/spring-data-couchbase" class="bare">https://github.com/spring-projects/spring-data-couchbase</a></p>
</li>
<li>
<p>Bugtracker - <a href="https://jira.springsource.org/browse/DATACOUCH" class="bare">https://jira.springsource.org/browse/DATACOUCH</a></p>
</li>
<li>
<p>Release repository - <a href="https://repo.spring.io/libs-release" class="bare">https://repo.spring.io/libs-release</a></p>
</li>
<li>
<p>Milestone repository - <a href="https://repo.spring.io/libs-milestone" class="bare">https://repo.spring.io/libs-milestone</a></p>
</li>
<li>
<p>Snapshot repository - <a href="https://repo.spring.io/libs-snapshot" class="bare">https://repo.spring.io/libs-snapshot</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase.migrating">Migrating from Spring Data Couchbase 3.x to 4.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter is a quick reference of what major changes have been introduced in 4.x and gives a high-level overview of things to consider when migrating.</p>
</div>
<div class="paragraph">
<p>Please note that implicitly the minimum Couchbase Server version has been bumped up to 5.5 and later, and we recommend running at least 6.0.x.</p>
</div>
<div class="sect2">
<h3 id="couchbase.migrating.configuration">Configuration</h3>
<div class="paragraph">
<p>Since the main objective was to migrate from the Java SDK 2 to 3, configuration has changed to adapt to the new SDK and also in the long run to prepare it for scopes and collections (but it can still be used without collection support).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
XML Configuration support has been dropped, so only java/annotation based configuration is supported.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Your configuration still has to extend the <code>AbstractCouchbaseConfiguration</code>, but since RBAC (role-based access control) is now mandatory, different properties need to be overridden in order to be configured: <code>getConnectionString</code>, <code>getUserName</code>, <code>getPassword</code> and <code>getBucketName</code>. If you want to use a non-default scope optionally you can override the <code>getScopeName</code> method. Note that if you want to use certificate based authentication or you need to customize the password authentication, the <code>authenticator</code> method can be overridden to perform this task.</p>
</div>
<div class="paragraph">
<p>The new SDK still has an environment that is used to configure it, so you can override the <code>configureEnvironment</code> method and supply custom configuration if needed.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#couchbase.configuration">Installation &amp; Configuration</a>.</p>
</div>
<div class="sect3">
<h4 id="_spring_boot_version_compatibility">Spring Boot Version Compatibility</h4>
<div class="paragraph">
<p>Spring Boot 2.3.x or higher depends on Spring Data Couchbase 4.x. Earlier versions of Couchbase are not available because SDK 2 and 3 cannot live on the same classpath.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.migrating.entities">Entities</h3>
<div class="paragraph">
<p>How to deal with entities has not changed, although since the SDK now does not ship annotations anymore only Spring-Data related annotations are supported.</p>
</div>
<div class="paragraph">
<p>Specifically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.couchbase.client.java.repository.annotation.Id</code> became <code>import org.springframework.data.annotation.Id</code></p>
</li>
<li>
<p><code>com.couchbase.client.java.repository.annotation.Field</code> became <code>import org.springframework.data.couchbase.core.mapping.Field</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>org.springframework.data.couchbase.core.mapping.Document</code> annotation stayed the same.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#couchbase.entity">Modeling Entities</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.migrating.indexes">Automatic Index Management</h3>
<div class="paragraph">
<p>Automatic Index Management has been redesigned to allow more flexible indexing. New annotations have been introduced and old ones like <code>@ViewIndexed</code>, <code>@N1qlSecondaryIndexed</code> and <code>@N1qlPrimaryIndexed</code> were removed.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#couchbase.repository.indexing">Automatic Index Management</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.migrating.template">Template and ReactiveTemplate</h3>
<div class="paragraph">
<p>Since the Couchbase SDK 3 removes support for <code>RxJava</code> and instead adds support for <code>Reactor</code>, both the <code>couchbaseTemplate</code> as well as the <code>reactiveCouchbaseTemplate</code> can be directly accessed from the <code>AbstractCouchbaseConfiguration</code>.</p>
</div>
<div class="paragraph">
<p>The template has been completely overhauled so that it now uses a fluent API to configure instead of many method overloads. This has the advantage that in the future we are able to extend the functionality without having to introduce more and more overloads that make it complicated to navigate.</p>
</div>
<div class="paragraph">
<p>The following table describes the method names in 3.x and compares them to their 4.x equivalents:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Template Method Comparison</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">SDC 3.x</th>
<th class="tableblock halign-left valign-top">SDC 4.x</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">save</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">upsertById</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">insert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">insertById</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">replaceById</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">findById</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">findById</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">findByView</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(removed)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">findBySpatialView</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(removed)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">findByN1QL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">findByQuery</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">findByN1QLProjection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">findByQuery</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">queryN1QL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(call SDK directly)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">existsById</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">remove</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">removeById</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">execute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(call SDK directly)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition, the following methods have been added which were not available in 3.x:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Template Additions in 4.x</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">removeByQuery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to remove entities through a N1QL query</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">findByAnalytics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Performs a find through the analytics service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">findFromReplicasById</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Like findById, but takes replicas into account</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We tried to unify and align the APIs more closely to the underlying SDK semantics so they are easier to correlate and navigate.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#couchbase.template">Template &amp; direct operations</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.migrating.repository">Repositories &amp; Queries</h3>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.data.couchbase.core.query.Query</code> became <code>org.springframework.data.couchbase.repository.Query</code></p>
</li>
<li>
<p><code>org.springframework.data.couchbase.repository.ReactiveCouchbaseSortingRepository</code> has been removed. Consider extending  <code>ReactiveSortingRepository</code> or <code>ReactiveCouchbaseRepository</code></p>
</li>
<li>
<p><code>org.springframework.data.couchbase.repository.CouchbasePagingAndSortingRepository</code> has been removed. Consider extending  <code>PagingAndSortingRepository</code> or <code>CouchbaseRepository</code></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Support for views has been removed and N1QL queries are now the first-class citizens for all custom repository methods as well as the built-in ones by default.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The behavior itself has not changed over the previous version on how the query derivation is supposed to work. Should you encounter any queries that worked in the past and now do not work anymore please let us know.</p>
</div>
<div class="paragraph">
<p>It is possible to override the default scan consistency for N1QL queries through the new <code>ScanConsistency</code> annotation.</p>
</div>
<div class="paragraph">
<p>The method <code>getCouchbaseOperations()</code> has also been removed. You can still access all methods from the native Java SDK via the class <code>CouchbaseTemplate</code> or <code>Cluster</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.couchbase.core.CouchbaseTemplate;
import org.springframework.stereotype.Service;
import com.couchbase.client.java.Cluster;

@Service
public class MyService {

    @Autowired
    private CouchbaseTemplate couchbaseTemplate;

    @Autowired
    private Cluster cluster;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See <a href="#couchbase.repository">Couchbase repositories</a> for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="_full_text_search_fts">Full Text Search (FTS)</h3>
<div class="paragraph">
<p>The FTS API has been simplified and now can be accessed via the <code>Cluster</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.couchbase.client.java.Cluster;
import com.couchbase.client.java.search.result.SearchResult;
import com.couchbase.client.java.search.result.SearchRow;
import com.couchbase.client.core.error.CouchbaseException;

@Service
public class MyService {

    @Autowired
    private Cluster cluster;

    public void myMethod() {
        try {
          final SearchResult result = cluster
            .searchQuery("index", SearchQuery.queryString("query"));

          for (SearchRow row : result.rows()) {
            System.out.println("Found row: " + row);
          }

          System.out.println("Reported total rows: "
            + result.metaData().metrics().totalRows());
        } catch (CouchbaseException ex) {
          ex.printStackTrace();
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://docs.couchbase.com/java-sdk/current/howtos/full-text-searching-with-sdk.html">the FTS Documentation</a> for more information.</p>
</div>
</div>
</div>
</div>
<h1 id="reference" class="sect0">Reference Documentation</h1>
<div class="sect1">
<h2 id="couchbase.configuration">Installation &amp; Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes the common installation and configuration steps needed when working with the library.</p>
</div>
<div class="sect2">
<h3 id="installation">Installation</h3>
<div class="paragraph">
<p>All versions intended for production use are distributed across Maven Central and the Spring release repository.
As a result, the library can be included like any other maven dependency:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Including the dependency through maven</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
    &lt;artifactId&gt;spring-data-couchbase&lt;/artifactId&gt;
    &lt;version&gt;4.2.5&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This will pull in several dependencies, including the underlying Couchbase Java SDK, common Spring dependencies and also Jackson as the JSON mapping infrastructure.</p>
</div>
<div class="paragraph">
<p>You can also grab snapshots from the <a href="https://repo.spring.io/ui/repos/tree/General/libs-snapshot/org/springframework/data/spring-data-couchbase">spring snapshot repository</a> ( https://repo.spring.io/libs-snapshot ) and milestone releases from the <a href="https://repo.spring.io/ui/repos/tree/General/libs-milestone/org/springframework/data/spring-data-couchbase">spring milestone repository</a> ( https://repo.spring.io/libs-milestone ).
Here is an example on how to use the current SNAPSHOT dependency:</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Using a snapshot version</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
  &lt;artifactId&gt;spring-data-couchbase&lt;/artifactId&gt;
  &lt;version&gt;4.3.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;

&lt;repository&gt;
  &lt;id&gt;spring-libs-snapshot&lt;/id&gt;
  &lt;name&gt;Spring Snapshot Repository&lt;/name&gt;
  &lt;url&gt;https://repo.spring.io/libs-snapshot&lt;/url&gt;
&lt;/repository&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once you have all needed dependencies on the classpath, you can start configuring it.
Only Java config is supported (XML config has been removed in 4.0).</p>
</div>
</div>
<div class="sect2">
<h3 id="configuration-java">Annotation-based Configuration ("JavaConfig")</h3>
<div class="paragraph">
<p>To get started, all you need to do is subclcass the <code>AbstractCouchbaseConfiguration</code> and implement the abstract methods.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Extending the <code>AbstractCouchbaseConfiguration</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
public class Config extends AbstractCouchbaseConfiguration {

    @Override
    public String getConnectionString() {
        return "couchbase://127.0.0.1";
    }

    @Override
    public String getUserName() {
        return "Administrator";
    }

    @Override
    public String getPassword() {
        return "password";
    }

    @Override
    public String getBucketName() {
        return "travel-sample";
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The connection string is made up of a list of hosts and an optional scheme (<code>couchbase://</code>) as shown in the code above.
All you need to provide is a list of Couchbase nodes to bootstrap into (separated by a <code>,</code>). Please note that while one
host is sufficient in development, it is recommended to add 3 to 5 bootstrap nodes here. Couchbase will pick up all nodes
from the cluster automatically, but it could be the case that the only node you&#8217;ve provided is experiencing issues while
you are starting the application.</p>
</div>
<div class="paragraph">
<p>The <code>userName</code> and <code>password</code> are configured in your Couchbase Server cluster through RBAC (role-based access control).
The <code>bucketName</code> reflects the bucket you want to use for this configuration.</p>
</div>
<div class="paragraph">
<p>Additionally, the SDK environment can be tuned by overriding the <code>configureEnvironment</code> method which takes a
<code>ClusterEnvironment.Builder</code> to return a configured <code>ClusterEnvironment</code>.</p>
</div>
<div class="paragraph">
<p>Many more things can be customized and overridden as custom beans from this configuration (for example repositories,
validation and custom converters).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If you use <code>SyncGateway</code> and <code>CouchbaseMobile</code>, you may run into problem with fields prefixed by <code>_</code>.
Since Spring Data Couchbase by default stores the type information as a <code>_class</code> attribute this can be problematic.
Override <code>typeKey()</code> (for example to return <code>MappingCouchbaseConverter.TYPEKEY_SYNCGATEWAY_COMPATIBLE</code>) to change the
name of said attribute.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you start your application, you should see Couchbase INFO level logging in the logs, indicating that the underlying
Couchbase Java SDK is connecting to the database. If any errors are reported, make sure that the given credentials
and host information are correct.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase.entity">Modeling Entities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes how to model Entities and explains their counterpart representation in Couchbase Server itself.</p>
</div>
<div class="paragraph">
<p>Unresolved directive in entity.adoc - include::../../../../spring-data-commons/src/main/asciidoc/object-mapping.adoc[leveloffset=+1]</p>
</div>
<div class="sect2">
<h3 id="basics">Documents and Fields</h3>
<div class="paragraph">
<p>All entities should be annotated with the <code>@Document</code> annotation, but it is not a requirement.</p>
</div>
<div class="paragraph">
<p>Also, every field in the entity should be annotated with the <code>@Field</code> annotation. While this is - strictly speaking -
optional, it helps to reduce edge cases and clearly shows the intent and design of the entity. It can also be used to
store the field under a different name.</p>
</div>
<div class="paragraph">
<p>There is also a special <code>@Id</code> annotation which needs to be always in place. Best practice is to also name the property
<code>id</code>.</p>
</div>
<div class="paragraph">
<p>Here is a very simple <code>User</code> entity:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. A simple Document with Fields</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.springframework.data.annotation.Id;
import org.springframework.data.couchbase.core.mapping.Field;
import org.springframework.data.couchbase.core.mapping.Document;

@Document
public class User {

    @Id
    private String id;

    @Field
    private String firstname;

    @Field
    private String lastname;

    public User(String id, String firstname, String lastname) {
        this.id = id;
        this.firstname = firstname;
        this.lastname = lastname;
    }

    public String getId() {
        return id;
    }

    public String getFirstname() {
        return firstname;
    }

    public String getLastname() {
        return lastname;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Couchbase Server supports automatic expiration for documents.
The library implements support for it through the <code>@Document</code> annotation.
You can set a <code>expiry</code> value which translates to the number of seconds until the document gets removed automatically.
If you want to make it expire in 10 seconds after mutation, set it like <code>@Document(expiry = 10)</code>.
Alternatively, you can configure the expiry using Spring&#8217;s property support and the <code>expiryExpression</code> parameter, to allow for dynamically changing the expiry value.
For example: <code>@Document(expiryExpression = "${valid.document.expiry}")</code>.
The property must be resolvable to an int value and the two approaches cannot be mixed.</p>
</div>
<div class="paragraph">
<p>If you want a different representation of the field name inside the document in contrast to the field name used in your entity, you can set a different name on the <code>@Field</code> annotation.
For example if you want to keep your documents small you can set the firstname field to <code>@Field("fname")</code>.
In the JSON document, you&#8217;ll see <code>{"fname": ".."}</code> instead of <code>{"firstname": ".."}</code>.</p>
</div>
<div class="paragraph">
<p>The <code>@Id</code> annotation needs to be present because every document in Couchbase needs a unique key.
This key needs to be any string with a length of maximum 250 characters.
Feel free to use whatever fits your use case, be it a UUID, an email address or anything else.</p>
</div>
</div>
<div class="sect2">
<h3 id="datatypes">Datatypes and Converters</h3>
<div class="paragraph">
<p>The storage format of choice is JSON. It is great, but like many data representations it allows less datatypes than you could express in Java directly.
Therefore, for all non-primitive types some form of conversion to and from supported types needs to happen.</p>
</div>
<div class="paragraph">
<p>For the following entity field types, you don&#8217;t need to add special handling:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Primitive Types</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Java Type</th>
<th class="tableblock halign-left valign-top">JSON Representation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">short</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">double</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ignored on write</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Since JSON supports objects ("maps") and lists, <code>Map</code> and <code>List</code> types can be converted naturally.
If they only contain primitive field types from the last paragraph, you don&#8217;t need to add special handling too.
Here is an example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. A Document with Map and List</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
public class User {

    @Id
    private String id;

    @Field
    private List&lt;String&gt; firstnames;

    @Field
    private Map&lt;String, Integer&gt; childrenAges;

    public User(String id, List&lt;String&gt; firstnames, Map&lt;String, Integer&gt; childrenAges) {
        this.id = id;
        this.firstnames = firstnames;
        this.childrenAges = childrenAges;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Storing a user with some sample data could look like this as a JSON representation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. A Document with Map and List - JSON</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "_class": "foo.User",
    "childrenAges": {
        "Alice": 10,
        "Bob": 5
    },
    "firstnames": [
        "Foo",
        "Bar",
        "Baz"
    ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You don&#8217;t need to break everything down to primitive types and Lists/Maps all the time.
Of course, you can also compose other objects out of those primitive values.
Let&#8217;s modify the last example so that we want to store a <code>List</code> of <code>Children</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. A Document with composed objects</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
public class User {

    @Id
    private String id;

    @Field
    private List&lt;String&gt; firstnames;

    @Field
    private List&lt;Child&gt; children;

    public User(String id, List&lt;String&gt; firstnames, List&lt;Child&gt; children) {
        this.id = id;
        this.firstnames = firstnames;
        this.children = children;
    }

    static class Child {
        private String name;
        private int age;

        Child(String name, int age) {
            this.name = name;
            this.age = age;
        }

    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A populated object can look like:</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. A Document with composed objects - JSON</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "_class": "foo.User",
  "children": [
    {
      "age": 4,
      "name": "Alice"
    },
    {
      "age": 3,
      "name": "Bob"
    }
  ],
  "firstnames": [
    "Foo",
    "Bar",
    "Baz"
  ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Most of the time, you also need to store a temporal value like a <code>Date</code>.
Since it can&#8217;t be stored directly in JSON, a conversion needs to happen.
The library implements default converters for <code>Date</code>, <code>Calendar</code> and JodaTime types (if on the classpath).
All of those are represented by default in the document as a unix timestamp (number).
You can always override the default behavior with custom converters as shown later.
Here is an example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. A Document with Date and Calendar</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
public class BlogPost {

    @Id
    private String id;

    @Field
    private Date created;

    @Field
    private Calendar updated;

    @Field
    private String title;

    public BlogPost(String id, Date created, Calendar updated, String title) {
        this.id = id;
        this.created = created;
        this.updated = updated;
        this.title = title;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A populated object can look like:</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. A Document with Date and Calendar - JSON</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "title": "a blog post title",
  "_class": "foo.BlogPost",
  "updated": 1394610843,
  "created": 1394610843897
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Optionally, Date can be converted to and from ISO-8601 compliant strings by setting system property <code>org.springframework.data.couchbase.useISOStringConverterForDate</code> to true.
If you want to override a converter or implement your own one, this is also possible.
The library implements the general Spring Converter pattern.
You can plug in custom converters on bean creation time in your configuration.
Here&#8217;s how you can configure it (in your overridden <code>AbstractCouchbaseConfiguration</code>):</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Custom Converters</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
public CustomConversions customConversions() {
    return new CustomConversions(Arrays.asList(FooToBarConverter.INSTANCE, BarToFooConverter.INSTANCE));
}

@WritingConverter
public static enum FooToBarConverter implements Converter&lt;Foo, Bar&gt; {
    INSTANCE;

    @Override
    public Bar convert(Foo source) {
        return /* do your conversion here */;
    }

}

@ReadingConverter
public static enum BarToFooConverter implements Converter&lt;Bar, Foo&gt; {
    INSTANCE;

    @Override
    public Foo convert(Bar source) {
        return /* do your conversion here */;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are a few things to keep in mind with custom conversions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To make it unambiguous, always use the <code>@WritingConverter</code> and <code>@ReadingConverter</code> annotations on your converters.
Especially if you are dealing with primitive type conversions, this will help to reduce possible wrong conversions.</p>
</li>
<li>
<p>If you implement a writing converter, make sure to decode into primitive types, maps and lists only.
If you need more complex object types, use the <code>CouchbaseDocument</code> and <code>CouchbaseList</code> types, which are also understood by the underlying translation engine.
Your best bet is to stick with as simple as possible conversions.</p>
</li>
<li>
<p>Always put more special converters before generic converters to avoid the case where the wrong converter gets executed.</p>
</li>
<li>
<p>For dates, reading converters should be able to read from any <code>Number</code> (not just <code>Long</code>).
This is required for N1QL support.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="version">Optimistic Locking</h3>
<div class="paragraph">
<p>In certain situations you may want to ensure that you are not overwriting another users changes when you perform a mutation operation on a document. For this you have three choices: Transactions (since Couchbase 6.5), pessimistic concurrency (locking) or optimistic concurrency.</p>
</div>
<div class="paragraph">
<p>Optimistic concurrency tends to provide better performance than pessimistic concurrency or transactions, because no actual locks are held on the data and no extra information is stored about the operation (no transaction log).</p>
</div>
<div class="paragraph">
<p>To implement optimistic locking, Couchbase uses a CAS (compare and swap) approach. When a document is mutated, the CAS value also changes.
The CAS is opaque to the client, the only thing you need to know is that it changes when the content or a meta information changes too.</p>
</div>
<div class="paragraph">
<p>In other datastores, similar behavior can be achieved through an arbitrary version field with a incrementing counter.
Since Couchbase supports this in a much better fashion, it is easy to implement.
If you want automatic optimistic locking support, all you need to do is add a <code>@Version</code> annotation on a long field like this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. A Document with optimistic locking.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
public class User {

        @Version
        private long version;

        // constructor, getters, setters...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you load a document through the template or repository, the version field will be automatically populated with the current CAS value.
It is important to note that you shouldn&#8217;t access the field or even change it on your own.
Once you save the document back, it will either succeed or fail with a <code>OptimisticLockingFailureException</code>.
If you get such an exception, the further approach depends on what you want to achieve application wise.
You should either retry the complete load-update-write cycle or propagate the error to the upper layers for proper handling.</p>
</div>
</div>
<div class="sect2">
<h3 id="validation">Validation</h3>
<div class="paragraph">
<p>The library supports JSR 303 validation, which is based on annotations directly in your entities.
Of course you can add all kinds of validation in your service layer, but this way its nicely coupled to your actual entities.</p>
</div>
<div class="paragraph">
<p>To make it work, you need to include two additional dependencies.
JSR 303 and a library that implements it, like the one supported by hibernate:</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Validation dependencies</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;javax.validation&lt;/groupId&gt;
  &lt;artifactId&gt;validation-api&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
  &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now you need to add two beans to your configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Validation beans</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
public LocalValidatorFactoryBean validator() {
    return new LocalValidatorFactoryBean();
}

@Bean
public ValidatingCouchbaseEventListener validationEventListener() {
    return new ValidatingCouchbaseEventListener(validator());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now you can annotate your fields with JSR303 annotations.
If a validation on <code>save()</code> fails, a <code>ConstraintViolationException</code> is thrown.</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. Sample Validation Annotation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Size(min = 10)
@Field
private String name;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="auditing">Auditing</h3>
<div class="paragraph">
<p>Entities can be automatically audited (tracing which user created the object, updated the object, and at what times) through Spring Data auditing mechanisms.</p>
</div>
<div class="paragraph">
<p>First, note that only entities that have a <code>@Version</code> annotated field can be audited for creation (otherwise the framework will interpret a creation as an update).</p>
</div>
<div class="paragraph">
<p>Auditing works by annotating fields with <code>@CreatedBy</code>, <code>@CreatedDate</code>, <code>@LastModifiedBy</code> and <code>@LastModifiedDate</code>.
The framework will automatically inject the correct values on those fields when persisting the entity.
The xxxDate annotations must be put on a <code>Date</code> field (or compatible, eg. jodatime classes) while the xxxBy annotations can be put on fields of any class <code>T</code> (albeit both fields must be of the same type).</p>
</div>
<div class="paragraph">
<p>To configure auditing, first you need to have an auditor aware bean in the context.
Said bean must be of type <code>AuditorAware&lt;T&gt;</code> (allowing to produce a value that can be stored in the xxxBy fields of type <code>T</code> we saw earlier).
Secondly, you must activate auditing in your <code>@Configuration</code> class by using the <code>@EnableCouchbaseAuditing</code> annotation.</p>
</div>
<div class="paragraph">
<p>Here is an example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Sample Auditing Entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
public class AuditedItem {

  @Id
  private final String id;

  private String value;

  @CreatedBy
  private String creator;

  @LastModifiedBy
  private String lastModifiedBy;

  @LastModifiedDate
  private Date lastModification;

  @CreatedDate
  private Date creationDate;

  @Version
  private long version;

  //..omitted constructor/getters/setters/...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice both <code>@CreatedBy</code> and <code>@LastModifiedBy</code> are both put on a <code>String</code> field, so our <code>AuditorAware</code> must work with <code>String</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. Sample AuditorAware implementation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class NaiveAuditorAware implements AuditorAware&lt;String&gt; {

  private String auditor = "auditor";

  @Override
  public String getCurrentAuditor() {
    return auditor;
  }

  public void setAuditor(String auditor) {
    this.auditor = auditor;
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To tie all that together, we use the java configuration both to declare an AuditorAware bean and to activate auditing:</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. Sample Auditing Configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
@EnableCouchbaseAuditing //this activates auditing
public class AuditConfiguration extends AbstractCouchbaseConfiguration {

    //... a few abstract methods omitted here

    // this creates the auditor aware bean that will feed the annotations
    @Bean
    public NaiveAuditorAware testAuditorAware() {
      return new NaiveAuditorAware();
    }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase.autokeygeneration">Auto generating keys</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes how couchbase document keys can be auto-generated using builtin mechanisms.
There are two types of auto-generation strategies supported.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#couchbase.autokeygeneration.usingattributes">Key generation using attributes</a></p>
</li>
<li>
<p><a href="#couchbase.autokeygeneration.unique">Key generation using uuid</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The maximum key length supported by couchbase is 250 bytes.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="couchbase.autokeygeneration.configuration">Configuration</h3>
<div class="paragraph">
<p>Keys to be auto-generated should be annotated with <code>@GeneratedValue</code>.
The default strategy is <code>USE_ATTRIBUTES</code>.
Prefix and suffix for the key can be provided as part of the entity itself, these values are not persisted, they are only used for key generation.
The prefixes and suffixes are ordered using the <code>order</code> value.
The default order is <code>0</code>, multiple prefixes without order will overwrite the previous.
If a value for id is already available, auto-generation will be skipped.
The delimiter for concatenation can be provided using <code>delimiter</code>, the default delimiter is <code>.</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. Annotation for GeneratedValue</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
public class User {
     @Id @GeneratedValue(strategy = USE_ATTRIBUTES, delimiter = ".")
     private String id;
     @IdPrefix(order=0)
     private String userPrefix;
     @IdSuffix(order=0)
     private String userSuffix;
     ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.autokeygeneration.usingattributes">Key generation using attributes</h3>
<div class="paragraph">
<p>It is a common practice to generate keys using a combination of the document attributes.
Key generation using attributes concatenates all the attribute values annotated with <code>IdAttribute</code>, based on the ordering provided similar to prefixes and suffixes.</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. Annotation for IdAttribute</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
public class User {
     @Id @GeneratedValue(strategy = USE_ATTRIBUTES)
     private String id;
     @IdAttribute
     private String userid;
     ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.autokeygeneration.unique">Key generation using uuid</h3>
<div class="paragraph">
<p>This auto-generation uses UUID random generator to generate document keys consuming 16 bytes of key space.
This mechanism is only recommended for test scaffolding.</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. Annotation for Unique key generation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
public class User {
     @Id @GeneratedValue(strategy = UNIQUE)
     private String id;
     ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Unresolved directive in index.adoc - include::../../../../spring-data-commons/src/main/asciidoc/repositories.adoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase.repository">Couchbase repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of Spring Data repository abstraction is to significantly reduce the amount of boilerplate code required to implement data access layers for various persistence stores.</p>
</div>
<div class="paragraph">
<p>By default, operations are backed by Key/Value if they are single-document operations and the ID is known. For all other operations by default N1QL queries are generated, and as a result proper indexes must be created for performant data access.</p>
</div>
<div class="paragraph">
<p>Note that you can tune the consistency you want for your queries (see <a href="#couchbase.repository.consistency">Querying with consistency</a>) and have different repositories backed by different buckets (see <a href="#couchbase.repository.multibucket">[couchbase.repository.multibucket]</a>)</p>
</div>
<div class="sect2">
<h3 id="couchbase.repository.configuration">Configuration</h3>
<div class="paragraph">
<p>While support for repositories is always present, you need to enable them in general or for a specific namespace.
If you extend <code>AbstractCouchbaseConfiguration</code>, just use the <code>@EnableCouchbaseRepositories</code> annotation.
It provides lots of possible options to narrow or customize the search path, one of the most common ones is <code>basePackages</code>.</p>
</div>
<div class="paragraph">
<p>Also note that if you are running inside spring boot, the autoconfig support already sets up the annotation for you so you only need to use it if you want to override the defaults.</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. Annotation-Based Repository Setup</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
@EnableCouchbaseRepositories(basePackages = {"com.couchbase.example.repos"})
public class Config extends AbstractCouchbaseConfiguration {
    //...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>An advanced usage is described in <a href="#couchbase.repository.multibucket">[couchbase.repository.multibucket]</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.repository.usage">Usage</h3>
<div class="paragraph">
<p>In the simplest case, your repository will extend the <code>CrudRepository&lt;T, String&gt;</code>, where T is the entity that you want to expose.
Let&#8217;s look at a repository for a UserInfo:</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. A UserInfo repository</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.springframework.data.repository.CrudRepository;

public interface UserRepository extends CrudRepository&lt;UserInfo, String&gt; {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Please note that this is just an interface and not an actual class.
In the background, when your context gets initialized, actual implementations for your repository descriptions get created and you can access them through regular beans.
This means you will save lots of boilerplate code while still exposing full CRUD semantics to your service layer and application.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s imagine we <code>@Autowire</code> the <code>UserRepository</code> to a class that makes use of it.
What methods do we have available?</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Exposed methods on the UserRepository</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UserInfo save(UserInfo entity)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Save the given entity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Iterable&lt;UserInfo&gt; save(Iterable&lt;UserInfo&gt; entity)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Save the list of entities.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UserInfo findOne(String id)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find a entity by its unique id.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean exists(String id)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check if a given entity exists by its unique id.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Iterable&lt;UserInfo&gt; findAll()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find all entities by this type in the bucket.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Iterable&lt;UserInfo&gt; findAll(Iterable&lt;String&gt; ids)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find all entities by this type and the given list of ids.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">long count()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Count the number of entities in the bucket.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">void delete(String id)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete the entity by its id.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">void delete(UserInfo entity)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete the entity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">void delete(Iterable&lt;UserInfo&gt; entities)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete all given entities.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">void deleteAll()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete all entities by type in the bucket.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Now that&#8217;s awesome!
Just by defining an interface we get full CRUD functionality on top of our managed entity.</p>
</div>
<div class="paragraph">
<p>While the exposed methods provide you with a great variety of access patterns, very often you need to define custom ones.
You can do this by adding method declarations to your interface, which will be automatically resolved to requests in the background, as we&#8217;ll see in the next sections.</p>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.repository.querying">Repositories and Querying</h3>
<div class="sect3">
<h4 id="couchbase.repository.n1ql">N1QL based querying</h4>
<div class="paragraph">
<p>Prerequisite is to have created a PRIMARY INDEX on the bucket where the entities will be stored.</p>
</div>
<div class="paragraph">
<p>Here is an example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. An extended UserInfo repository with N1QL queries</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface UserRepository extends CrudRepository&lt;UserInfo, String&gt; {

    @Query("#{#n1ql.selectEntity} WHERE role = 'admin' AND #{#n1ql.filter}")
    List&lt;UserInfo&gt; findAllAdmins();

    List&lt;UserInfo&gt; findByFirstname(String fname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here we see two N1QL-backed ways of querying.</p>
</div>
<div class="paragraph">
<p>The first method uses the <code>Query</code> annotation to provide a N1QL statement inline.
SpEL (Spring Expression Language) is supported by surrounding SpEL expression blocks between <code>#{</code> and <code>}</code>.
A few N1QL-specific values are provided through SpEL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>#n1ql.selectEntity</code> allows to easily make sure the statement will select all the fields necessary to build the full entity (including document ID and CAS value).</p>
</li>
<li>
<p><code>#n1ql.filter</code> in the WHERE clause adds a criteria matching the entity type with the field that Spring Data uses to store type information.</p>
</li>
<li>
<p><code>#n1ql.bucket</code> will be replaced by the name of the bucket the entity is stored in, escaped in backticks.</p>
</li>
<li>
<p><code>#n1ql.scope</code> will be replaced by the name of the scope the entity is stored in, escaped in backticks.</p>
</li>
<li>
<p><code>#n1ql.collection</code> will be replaced by the name of the collection the entity is stored in, escaped in backticks.</p>
</li>
<li>
<p><code>#n1ql.fields</code> will be replaced by the list of fields (eg. for a SELECT clause) necessary to reconstruct the entity.</p>
</li>
<li>
<p><code>#n1ql.delete</code> will be replaced by the <code>delete from</code> statement.</p>
</li>
<li>
<p><code>#n1ql.returning</code> will be replaced by returning clause needed for reconstructing entity.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
We recommend that you always use the <code>selectEntity</code> SpEL and a WHERE clause with a <code>filter</code> SpEL (since otherwise your query could be impacted by entities from other repositories).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>String-based queries support parametrized queries.
You can either use positional placeholders like &#8220;$1&#8221;, in which case each of the method parameters will map, in order, to <code>$1</code>, <code>$2</code>, <code>$3</code>&#8230;&#8203; Alternatively, you can use named placeholders using the &#8220;$someString&#8221; syntax.
Method parameters will be matched with their corresponding placeholder using the parameter&#8217;s name, which can be overridden by annotating each parameter (except a <code>Pageable</code> or <code>Sort</code>) with <code>@Param</code> (eg. <code>@Param("someString")</code>).
You cannot mix the two approaches in your query and will get an <code>IllegalArgumentException</code> if you do.</p>
</div>
<div class="paragraph">
<p>Note that you can mix N1QL placeholders and SpEL. N1QL placeholders will still consider all method parameters, so be sure to use the correct index like in the example below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. An inline query that mixes SpEL and N1QL placeholders</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Query("#{#n1ql.selectEntity} WHERE #{#n1ql.filter} AND #{[0]} = $2")
public List&lt;User&gt; findUsersByDynamicCriteria(String criteriaField, Object criteriaValue)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This allows you to generate queries that would work similarly to eg. <code>AND name = "someName"</code> or <code>AND age = 3</code>, with a single method declaration.</p>
</div>
<div class="paragraph">
<p>You can also do single projections in your N1QL queries (provided it selects only one field and returns only one result, usually an aggregation like <code>COUNT</code>, <code>AVG</code>, <code>MAX</code>&#8230;&#8203;).
Such projection would have a simple return type like <code>long</code>, <code>boolean</code> or <code>String</code>.
This is <strong>NOT</strong> intended for projections to DTOs.</p>
</div>
<div class="paragraph">
<p>Another example:<br>
<code>#{#n1ql.selectEntity} WHERE #{#n1ql.filter} AND test = $1</code><br>
is equivalent to<br>
<code>SELECT #{#n1ql.fields} FROM #{#n1ql.collection} WHERE #{#n1ql.filter} AND test = $1</code></p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">A practical application of SpEL with Spring Security</div>
<div class="paragraph">
<p>SpEL can be useful when you want to do a query depending on data injected by other Spring components, like Spring Security.
Here is what you need to do to extend the SpEL context to get access to such external data.</p>
</div>
<div class="paragraph">
<p>First, you need to implement an <code>EvaluationContextExtension</code> (use the support class as below):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class SecurityEvaluationContextExtension extends EvaluationContextExtensionSupport {

  @Override
  public String getExtensionId() {
    return "security";
  }

  @Override
  public SecurityExpressionRoot getRootObject() {
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    return new SecurityExpressionRoot(authentication) {};
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then all you need to do for Spring Data Couchbase to be able to access associated SpEL values is to declare a corresponding bean in your configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
EvaluationContextExtension securityExtension() {
    return new SecurityEvaluationContextExtension();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This could be useful to craft a query according to the role of the connected user for instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Query("#{#n1ql.selectEntity} WHERE #{#n1ql.filter} AND " +
"role = '?#{hasRole('ROLE_ADMIN') ? 'public_admin' : 'admin'}'")
List&lt;UserInfo&gt; findAllAdmins(); //only ROLE_ADMIN users will see hidden admins</code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete query example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Query("#{#n1ql.delete} WHERE #{#n1ql.filter} AND " +
"username = $1 #{#n1ql.returning}")
UserInfo removeUser(String username);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The second method uses Spring-Data&#8217;s query derivation mechanism to build a N1QL query from the method name and parameters.
This will produce a query looking like this: <code>SELECT &#8230;&#8203; FROM &#8230;&#8203; WHERE firstName = "valueOfFnameAtRuntime"</code>.
You can combine these criteria, even do a count with a name like <code>countByFirstname</code> or a limit with a name like <code>findFirst3ByLastname</code>&#8230;&#8203;</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Actually the generated N1QL query will also contain an additional N1QL criteria in order to only select documents that match the repository&#8217;s entity class.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most Spring-Data keywords are supported:
.Supported keywords inside @Query (N1QL) method names</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Keyword</th>
<th class="tableblock halign-left valign-top">Sample</th>
<th class="tableblock halign-left valign-top">N1QL WHERE clause snippet</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>And</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLastnameAndFirstname</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lastName = a AND firstName = b</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Or</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLastnameOrFirstname</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lastName = a OR firstName = b</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Is,Equals</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByField</code>,<code>findByFieldEquals</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field = a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNot,Not</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldIsNot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field != a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Between</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldBetween</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field BETWEEN a AND b</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsLessThan,LessThan,IsBefore,Before</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldIsLessThan</code>,<code>findByFieldBefore</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field &lt; a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsLessThanEqual,LessThanEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldIsLessThanEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field &#8656; a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsGreaterThan,GreaterThan,IsAfter,After</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldIsGreaterThan</code>,<code>findByFieldAfter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field &gt; a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsGreaterThanEqual,GreaterThanEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldGreaterThanEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field &gt;= a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldIsNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field IS NULL</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNotNull,NotNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldIsNotNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field IS NOT NULL</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsLike,Like</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldLike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field LIKE "a"</code> - a should be a String containing % and _ (matching n and 1 characters)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNotLike,NotLike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldNotLike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field NOT LIKE "a"</code> - a should be a String containing % and _ (matching n and 1 characters)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsStartingWith,StartingWith,StartsWith</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldStartingWith</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field LIKE "a%"</code> - a should be a String prefix</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsEndingWith,EndingWith,EndsWith</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldEndingWith</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field LIKE "%a"</code> - a should be a String suffix</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsContaining,Containing,Contains</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldContains</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field LIKE "%a%"</code> - a should be a String</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNotContaining,NotContaining,NotContains</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldNotContaining</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field NOT LIKE "%a%"</code> - a should be a String</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsIn,In</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldIn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field IN array</code> - note that the next parameter value (or its children if a collection/array) should be compatible for storage in a <code>JsonArray</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNotIn,NotIn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldNotIn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field NOT IN array</code> - note that the next parameter value (or its children if a collection/array) should be compatible for storage in a <code>JsonArray</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsTrue,True</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldIsTrue</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field = TRUE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsFalse,False</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldFalse</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field = FALSE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MatchesRegex,Matches,Regex</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldMatches</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REGEXP_LIKE(field, "a")</code> - note that the ignoreCase is ignored here, a is a regular expression in String form</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Exists</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldExists</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field IS NOT MISSING</code> - used to verify that the JSON contains this attribute</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OrderBy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldOrderByLastnameDesc</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>field = a ORDER BY lastname DESC</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IgnoreCase</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFieldIgnoreCase</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LOWER(field) = LOWER("a")</code> - a must be a String</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can use both counting queries and <a href="#repositories.limit-query-result">[repositories.limit-query-result]</a> features with this approach.</p>
</div>
<div class="paragraph">
<p>With N1QL, another possible interface for the repository is the <code>PagingAndSortingRepository</code> one (which extends <code>CrudRepository</code>).
It adds two methods:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Exposed methods on the PagingAndSortingRepository</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Iterable&lt;T&gt; findAll(Sort sort);</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to retrieve all relevant entities while sorting on one of their attributes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page&lt;T&gt; findAll(Pageable pageable);</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to retrieve your entities in pages. The returned <code>Page</code> allows to easily get the next page&#8217;s <code>Pageable</code> as well as the list of items. For the first call, use <code>new PageRequest(0, pageSize)</code> as Pageable.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can also use <code>Page</code> and <code>Slice</code> as method return types as well with a N1QL backed repository.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If pageable and sort parameters are used with inline queries, there should not be any order by, limit or offset clause in the inline query itself otherwise the server would reject the query as malformed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="couchbase.repository.indexing">Automatic Index Management</h4>
<div class="paragraph">
<p>By default, it is expected that the user creates and manages optimal indexes for their queries. Especially in the early stages of development, it can come in handy to automatically create indexes to get going quickly.</p>
</div>
<div class="paragraph">
<p>For N1QL, the following annotations are provided which need to be attached to the entity (either on the class or the field):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@QueryIndexed</code>: Placed on a field to signal that this field should be part of the index</p>
</li>
<li>
<p><code>@CompositeQueryIndex</code>: Placed on the class to signal that an index on more than one field (composite) should be created.</p>
</li>
<li>
<p><code>@CompositeQueryIndexes</code>: If more than one <code>CompositeQueryIndex</code> should be created, this annotation will take a list of them.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, this is how you define a composite index on an entity:</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Composite index on two fields with ordering</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
@CompositeQueryIndex(fields = {"id", "name desc"})
public class Airline {
   @Id
   String id;

	@QueryIndexed
	String name;

	@PersistenceConstructor
	public Airline(String id, String name) {
		this.id = id;
	}

	public String getId() {
		return id;
	}

	public String getName() {
		return name;
	}

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>By default, index creation is disabled. If you want to enable it you need to override it on the configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. Enable auto index creation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
protected boolean autoIndexCreation() {
 return true;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="couchbase.repository.consistency">Querying with consistency</h4>
<div class="paragraph">
<p>By default repository queries that use N1QL use the <code>NOT_BOUNDED</code> scan consistency. This means that results return quickly, but the data from the index may not yet contain data from previously written operations (called eventual consistency). If you need "ready your own write" semantics for a query, you need to use the <code>@ScanConsistency</code> annotation. Here is an example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 28. Using a different scan consistency</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Repository
public interface AirportRepository extends PagingAndSortingRepository&lt;Airport, String&gt; {

	@Override
	@ScanConsistency(query = QueryScanConsistency.REQUEST_PLUS)
	Iterable&lt;Airport&gt; findAll();

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dto_projections">DTO Projections</h4>
<div class="paragraph">
<p>Spring Data Repositories usually return the domain model when using query methods.
However, sometimes, you may need to alter the view of that model for various reasons.
In this section, you will learn how to define projections to serve up simplified and reduced views of resources.</p>
</div>
<div class="paragraph">
<p>Look at the following domain model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Entity
public class Person {

  @Id @GeneratedValue
  private Long id;
  private String firstName, lastName;

  @OneToOne
  private Address address;
  â¦
}

@Entity
public class Address {

  @Id @GeneratedValue
  private Long id;
  private String street, state, country;

  â¦
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>Person</code> has several attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> is the primary key</p>
</li>
<li>
<p><code>firstName</code> and <code>lastName</code> are data attributes</p>
</li>
<li>
<p><code>address</code> is a link to another domain object</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now assume we create a corresponding repository as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">interface PersonRepository extends CrudRepository&lt;Person, Long&gt; {

  Person findPersonByFirstName(String firstName);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring Data will return the domain object including all of its attributes.
There are two options just to retrieve the <code>address</code> attribute.
One option is to define a repository for <code>Address</code> objects like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">interface AddressRepository extends CrudRepository&lt;Address, Long&gt; {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this situation, using <code>PersonRepository</code> will still return the whole <code>Person</code> object.
Using <code>AddressRepository</code> will return just the <code>Address</code>.</p>
</div>
<div class="paragraph">
<p>However, what if you do not want to expose <code>address</code> details at all?
You can offer the consumer of your repository service an alternative by defining one or more projections.</p>
</div>
<div class="exampleblock">
<div class="title">Example 29. Simple Projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">interface NoAddresses {  <b class="conum">(1)</b>

  String getFirstName(); <b class="conum">(2)</b>

  String getLastName();  <b class="conum">(3)</b>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This projection has the following details:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A plain Java interface making it declarative.</p>
</li>
<li>
<p>Export the <code>firstName</code>.</p>
</li>
<li>
<p>Export the <code>lastName</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>NoAddresses</code> projection only has getters for <code>firstName</code> and <code>lastName</code> meaning that it will not serve up any address information.
The query method definition returns in this case <code>NoAdresses</code> instead of <code>Person</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">interface PersonRepository extends CrudRepository&lt;Person, Long&gt; {

  NoAddresses findByFirstName(String firstName);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Projections declare a contract between the underlying type and the method signatures related to the exposed properties.
Hence it is required to name getter methods according to the property name of the underlying type.
If the underlying property is named <code>firstName</code>, then the getter method must be named <code>getFirstName</code> otherwise Spring Data is not able to look up the source property.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase.reactiverepository">Reactive Couchbase repository</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="couchbase.reactiverepository.intro">Introduction</h3>
<div class="paragraph">
<p>This chapter describes the reactive repository support for couchbase.
This builds on the core repository support explained in <a href="#couchbase.repository">Couchbase repositories</a>.
So make sure youâve got a sound understanding of the basic concepts explained there.</p>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.reactiverepository.libraries">Reactive Composition Libraries</h3>
<div class="paragraph">
<p>The Couchbase Java SDK 3.x moved from RxJava to Reactor, so it blends in very nicely with the reactive spring ecosystem.</p>
</div>
<div class="paragraph">
<p>Reactive Couchbase repositories provide project Reactor wrapper types and can be used by simply extending from one of the library-specific repository interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ReactiveCrudRepository</p>
</li>
<li>
<p>ReactiveSortingRepository</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.reactiverepository.usage">Usage</h3>
<div class="paragraph">
<p>Let&#8217;s create a simple entity to start with:</p>
</div>
<div class="exampleblock">
<div class="title">Example 30. Sample Person entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class Person {

  @Id
  private String id;
  private String firstname;
  private String lastname;
  private Address address;

  // â¦ getters and setters omitted
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A corresponding repository implementation may look like this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 31. Basic repository interface to persist Person entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>public interface ReactivePersonRepository extends ReactiveSortingRepository&lt;Person, Long&gt; {

  Flux&lt;Person&gt; findByFirstname(String firstname);

  Flux&lt;Person&gt; findByFirstname(Publisher&lt;String&gt; firstname);

  Flux&lt;Person&gt; findByFirstnameOrderByLastname(String firstname, Pageable pageable);

  Mono&lt;Person&gt; findByFirstnameAndLastname(String firstname, String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For JavaConfig use the <code>@EnableReactiveCouchbaseRepositories</code> annotation.
The annotation carries the very same attributes like the namespace element.
If no base package is configured the infrastructure will scan the package of the annotated configuration class.</p>
</div>
<div class="paragraph">
<p>Also note that if you are using it in a spring boot setup you likely can omit the annotation since it is autoconfigured for you.</p>
</div>
<div class="exampleblock">
<div class="title">Example 32. JavaConfig for repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
@EnableReactiveCouchbaseRepositories
class ApplicationConfig extends AbstractCouchbaseConfiguration {
	// ... (see configuration for details)
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As our domain repository extends <code>ReactiveSortingRepository</code> it provides you with CRUD operations as well as methods for sorted access to the entities.
Working with the repository instance is just a matter of dependency injecting it into a client.</p>
</div>
<div class="exampleblock">
<div class="title">Example 33. Sorted access to Person entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class PersonRepositoryTests {

    @Autowired
    ReactivePersonRepository repository;

    @Test
    public void sortsElementsCorrectly() {
      Flux&lt;Person&gt; persons = repository.findAll(Sort.by(new Order(ASC, "lastname")));
      assertNotNull(perons);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.reactiverepository.querying">Repositories and Querying</h3>
<div class="paragraph">
<p>Spring Data&#8217;s Reactive Couchbase comes with full querying support already provided by the blocking <a href="#couchbase.repository.querying">Repositories and Querying</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase.template">Template &amp; direct operations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The template provides lower level access to the underlying database and also serves as the foundation for repositories.
Any time a repository is too high-level for you needs chances are good that the templates will serve you well. Note that
you can always drop into the SDK directly through the beans exposed on the <code>AbstractCouchbaseConfiguration</code>.</p>
</div>
<div class="sect2">
<h3 id="template.ops">Supported operations</h3>
<div class="paragraph">
<p>The template can be accessed through the <code>couchbaseTemplate</code>  and <code>reactiveCouchbaseTemplate</code> beans out of your context.
Once you&#8217;ve got a reference to it, you can run all kinds of operations against it.
Other than through a repository, in a template you need to always specify the target entity type which you want to get converted.</p>
</div>
<div class="paragraph">
<p>The templates use a fluent-style API which allows you to chain in optional operators as needed. As an example, here is
how you store a user and then find it again by its ID:</p>
</div>
<div class="exampleblock">
<div class="title">Example 34. Fluent template access</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Create an Entity
User user = new User(UUID.randomUUID().toString(), "firstname", "lastname");

// Upsert it
couchbaseTemplate.upsertById(User.class).one(user);

// Retrieve it again
User found = couchbaseTemplate.findById(User.class).one(user.getId());</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you wanted to use a custom durability requirement for the <code>upsert</code> operation you can chain it in:</p>
</div>
<div class="exampleblock">
<div class="title">Example 35. Upsert with durability</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">User modified = couchbaseTemplate
  .upsertById(User.class)
  .withDurability(DurabilityLevel.MAJORITY)
  .one(user);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In a similar fashion, you can perform a N1QL operation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 36. N1QL query on the template</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">final List&lt;User&gt; foundUsers = couchbaseTemplate
  .findByQuery(User.class)
  .consistentWith(QueryScanConsistency.REQUEST_PLUS)
  .all();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase.transactions">Couchbase Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase supports <a href="https://docs.couchbase.com/server/current/learn/data/transactions.html">Distributed Transactions</a>. This section documents how to use it with Spring Data Couchbase.</p>
</div>
<div class="sect2">
<h3 id="_requirements">Requirements</h3>
<div class="ulist">
<ul>
<li>
<p>Couchbase Server 6.6.1 or aabove.</p>
</li>
<li>
<p>Spring Data Couchbase 5.0.0-M5 or above.</p>
</li>
<li>
<p>NTP should be configured so nodes of the Couchbase cluster are in sync with time. The time being out of sync will not cause incorrect behavior, but can impact metadata cleanup.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_getting_started_configuration">Getting Started &amp; Configuration</h3>
<div class="paragraph">
<p>Couchbase Transactions are normally leveraged with the @Transactional operator.
The @Transactional operator is implemented with the CouchbaseTransactionManager which is supplied as a bean in the AbstractCouchbaseConfiguration.</p>
</div>
<div class="exampleblock">
<div class="title">Example 37. Transaction Configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
@EnableCouchbaseRepositories("&lt;parent-dir-of-repository-interfaces&gt;")
@EnableReactiveCouchbaseRepositories("&lt;parent-dir-of-repository-interfaces&gt;")
@EnableTransactionManagement // Add for @Transactional annotation support
static class Config extends AbstractCouchbaseConfiguration {

// Usual Setup
@Override public String getConnectionString() { /* ... */ }
@Override public String getUserName() { /* ... */ }
@Override public String getPassword() { /* ... */ }
@Override public String getBucketName() { /* ... */ }

// Customization of transaction behavior is via the configureEnvironment() method
@Override
public void configureEnvironment(ClusterEnvironment.Builder builder) {
  // allow really long transactions
  builder.transactionsConfig(
    TransactionsConfig.builder().timeout(Duration.ofSeconds(30)));
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Functioning of the  @Transactional method annotation requires</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p>the configuration class to be annotated with @EnableTransactionManagement;</p>
</li>
<li>
<p>the service object with the annotated methods must be annotated with @Service and @Component;</p>
</li>
<li>
<p>the service object with the annotated methods must be obtained as an @Bean either via @Autowire or
from the application context;</p>
</li>
<li>
<p>the call to the method must be made from a different class than service because calling an annotated
method from the same class will not invoke the Method Interceptor that does the transaction processing.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_transactions_with_transactional">Transactions with @Transactional</h3>
<div class="paragraph">
<p>@Transactional Defines as transactional a method or all methods on a class.</p>
</div>
<div class="paragraph">
<p>When this annotation is declared at the class level, it applies as a default
to all methods of the declaring class and its subclasses. Note that it does not
apply to ancestor classes up the class hierarchy; inherited methods need to be
locally redeclared in order to participate in a subclass-level annotation. For
details on method visibility constraints, consult the
<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#transaction">Transaction Management</a>
section of the reference manual.</p>
</div>
<div class="sect3">
<h4 id="_attribute_semantics">Attribute Semantics</h4>
<div class="paragraph">
<p>In this release, he Couchbase Transactions implementation in
Spring Data Couchbase ignores all @Transactional attributes.
The transaction will roll back on uncaught exceptions.
The transaction isoloation level is read committed;</p>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_management">Transaction Management</h4>
<div class="paragraph">
<p>Blocking transactions are thread-bound and therefore do not propagate to newly started threads within the method.
Non-blocking transactions are bound to the reactive context.</p>
</div>
<div class="exampleblock">
<div class="title">Example 38. Transaction Access</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// this object must be provided by the Spring framework either by @Autowire or from ac.getBean().
// If created directly with its constructor, the method interceptor will not be called.
@Autowired PersonService personService;

Person walterWhite = new Person( "Walter", "White");
Person p = personService.save(walterWhite);

----------

import reactor.core.publisher.Mono;
import reactor.core.publisher.Flux;

import org.springframework.stereotype.Component;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

final CouchbaseOperations personOperations;
final ReactiveCouchbaseOperations reactivePersonOperations;

@Service
@Component
public class PersonService {

  final CouchbaseOperations operations;
  final ReactiveCouchbaseOperations reactiveOperations;

  // This method will be called for @Autowired using the
  // CouchbaseOperations and ReactiveCouchbaseOperations @Beans
  public PersonService(CouchbaseOperations ops, ReactiveCouchbaseOperations reactiveOps) {
    operations = ops;
    reactiveOperations = reactiveOps;
  }

  @Transactional
  public Person save(Person p) {
    return operations.save(p);
  }

  @Transactional
  public Person changeFirstName(String id, String newFirstName) {
    Person p = operations.findById(Person.class).one(id);
    return operations.replaceById(Person.class).one(p.withFirstName(newFirstName);
  }

  @Transactional
  public Mono&lt;Person&gt; reactiveChangeFirstName(String id, String newFirstName) {
    return personOperationsRx.findById(Person.class).one(person.id())
        .flatMap(p -&gt; personOperationsRx.replaceById(Person.class).one(p.withFirstName(newFirstName)));
  }


}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transactions_with_couchbasetransactionaloperator">Transactions with CouchbaseTransactionalOperator</h3>
<div class="paragraph">
<p>CouchbaseTransactionalOperator can be used to construct a tansaction in-line without creating a service class that uses @Transactional.
CouchbaseTransactionalOperator is available as a bean and can be instantiated with @Autowire.
If creating one explicitly, it must be created with the following (and not TransactionalOperator.create(manager) as described in general Spring Data transaction documenation).
.TransactionalOperator Construction</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static CouchbaseTransactionalOperator create(CouchbaseCallbackTransactionManager manager)</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 39. Transaction Access Using TransactionalOperator.execute()</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Autowired TransactionalOperator txOperator;
@Autowired ReactiveCouchbaseTemplate reactiveCouchbaseTemplate;

Person person = reactiveCouchbaseTemplate.insertById(Person.class).inCollection(cName).one(WalterWhite).block();
Flux&lt;Person&gt; result = txOperator.execute((ctx) -&gt; reactiveCouchbaseTemplate.findById(Person.class).one(person.id())
  .flatMap(p -&gt; reactiveCouchbaseTemplate.replaceById(Person.class).one(p.withFirstName("Walt"))));
result.blockLast();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transactions_directly_with_the_sdk">Transactions Directly with the SDK</h3>
<div class="paragraph">
<p>Please see the <a href="https://docs.couchbase.com/java-sdk/current/howtos/distributed-acid-transactions-from-the-sdk.html">Reference Documentation</a></p>
</div>
<div class="exampleblock">
<div class="title">Example 40. Transaction Access - Blocking</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Autowired ReactiveCouchbaseTemplate reactiveCouchbaseTemplate;

TransactionResult result = reactiveCouchbaseTemplate.getCouchbaseClientFactory().getCluster().transactions().run(ctx -&gt; {
  return reactiveCouchbaseTemplate.insertById(Person.class).one(WalterWhite);
});</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 41. Transaction Access - Reactive</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Autowired ReactiveCouchbaseTemplate reactiveCouchbaseTemplate;

TransactionResult result = reactiveCouchbaseTemplate.getCouchbaseClientFactory().getCluster().reactive().transactions()
    .run(ctx -&gt; TransactionalSupport.checkForTransactionInThreadLocalStorage().then(Mono.defer(() -&gt; {
      reactiveCouchbaseTemplate.insertById(Person.class).one(WalterWhite);
    }))).block();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase.collections">Collection Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase supports <a href="https://docs.couchbase.com/server/current/learn/data/scopes-and-collections.html">Scopes and Collections</a>. This section documents on how to use it with Spring Data Couchbase.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/couchbaselabs/try-cb-spring">try-cb-spring</a> sample application is a working example of using Scopes and Collections in Spring Data Couchbase.</p>
</div>
<div class="paragraph">
<p>The 2021 Couchbase Connect presentation on Collections in Spring Data can be found at <a href="https://www.youtube.com/watch?v=MrplTeEFItk">Presentation Only</a> and <a href="https://web.cvent.com/hub/events/1dce8283-986d-4de9-8368-94c98f60df01/sessions/9ee89a85-833c-4e0c-81b0-807864fa351b?goBackHref=%2Fevents%2F1dce8283-986d-4de9-8368-94c98f60df01%2Fsessions&amp;goBackName=Add%2FView+Sessions&amp;goBackTab=all">Presentation with Slide Deck</a></p>
</div>
<div class="sect2">
<h3 id="_requirements_2">Requirements</h3>
<div class="ulist">
<ul>
<li>
<p>Couchbase Server 7.0 or above.</p>
</li>
<li>
<p>Spring Data Couchbase 4.3.1 or above.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_getting_started_configuration_2">Getting Started &amp; Configuration</h3>
<div class="sect3">
<h4 id="_scope_and_collection_specification">Scope and Collection Specification</h4>
<div class="paragraph">
<p>There are several mechanisms of specifying scopes and collections, and these may be combined, or one mechanism may override another.
First some definitions for scopes and collections. An unspecified scope indicates that the default scope is to be used, likewise, an
unspecified collection indicates that the default collection is to be used.
There are only three combinations of scopes and collections that are valid. (1) the default scope and the default collection; (2) the default
scope and a non-default collection; and (3) a non-default scope and a non-default collection. It is not possible to have a non-default
scope and a default collection as non-default scopes do not contain a default collections, neither can one be created.</p>
</div>
<div class="paragraph">
<p>A scope can be specified in the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
static class Config extends AbstractCouchbaseConfiguration {

    // Usual Setup
    @Override public String getConnectionString() { /* ... */ }

    // optionally specify the scope in the Configuration
    @Override
    protected String getScopeName() {
        return "myScope"; // or a variable etc.;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scopes and Collections can be specified as annotations on entity classes and repositories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
@Scope("travel")
@Collection("airport")
public class Airport {...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Scope("travel")
@Collection("airport")
public interface AirportRepository extends CouchbaseRepository&lt;Airport, String&gt; ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scopes and Collections can be specified on templates using the inScope(scopeName) and inCollection(collectionName) fluent APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">List&lt;Airport&gt; airports = template.findByQuery(Airport.class).inScope("archived").all()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scopes and Collections can be specified on repositories that extend DynamicProxyable using the withScope(scopeName) and withCollection(collectionName) APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface AirportRepository extends CouchbaseRepository&lt;Airport, String&gt;, DynamicProxyable&lt;AirportRepository&gt;{...}
...
List&lt;Airport&gt; airports = airportRepository.withScope("archived").findByName(iata);</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">The order of precedence is:</div>
<ol class="arabic">
<li>
<p>inScope()/inCollection() of the template fluent api</p>
</li>
<li>
<p>withScope()/withCollection() of the template/repository object</p>
</li>
<li>
<p>annotation of the repository method</p>
</li>
<li>
<p>annotation of the repository interface</p>
</li>
<li>
<p>annotation of the entity object</p>
</li>
<li>
<p>getScope() of the configuration</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase.ansijoins">ANSI Joins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes hows ANSI joins can be used across entities.
Since 5.5 version, Couchbase server provides support for ANSI joins for joining documents using fields.
Previous versions allowed index &amp; lookup joins, which were supported in SDC only by querying directly through the SDK.</p>
</div>
<div class="paragraph">
<p>Relationships between entities across repositories can be one to one or one to many.
By defining such relationships, a synchronized view of associated entities can be fetched.</p>
</div>
<div class="sect2">
<h3 id="couchbase.ansijoins.configuration">Configuration</h3>
<div class="paragraph">
<p>Associated entities can be fetched by annotating the entity&#8217;s property reference with <code>@N1qlJoin</code>.
The prefix <code>lks</code> refers to left-hand side key space (current entity) and <code>rks</code> refers to the right-hand side key space (associated entity).
The required element for <code>@N1qlJoin</code> annotation is the <code>on</code> clause, a boolean expression representing the join condition between the left-hand side (<code>lks</code>) and the right-hand side (<code>rks</code>), which can be fields, constant expressions or any complex N1QL expression.
There could also be an optional <code>where</code> clause specified on the annotation for the join, similarly using
<code>lks</code> to refer the current entity and <code>rks</code> to refer the associated entity.</p>
</div>
<div class="exampleblock">
<div class="title">Example 42. Annotation for ANSI Join</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document
public class Author {
      @Id
      String id;

      String name;

      @N1qlJoin(on = "lks.name=rks.authorName")
      List&lt;Book&gt; books;

      @N1qlJoin(on = "lks.name=rks.name")
      Address address;
     ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.ansijoins.fetchtype">Lazy fetching</h3>
<div class="paragraph">
<p>Associated entities can be lazily fetched upon the first access of the property, this could save on fetching more data than required when loading the entity.
To load the associated entities lazily, <code>@N1qlJoin</code> annotation&#8217;s element <code>fetchType</code>
has to be set to <code>FetchType.LAZY</code>.
The default is <code>FetchType.IMMEDIATE</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 43. Configuration for lazy fetch</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@N1qlJoin(on = "lks.name=rks.authorName", fetchType = FetchType.LAZY)
List&lt;Book&gt; books;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="couchbase.ansijoins.joinhints">ANSI Join Hints</h3>
<div class="sect3">
<h4 id="_use_index_hint">Use Index Hint</h4>
<div class="paragraph">
<p><code>index</code> element on the <code>@N1qlJoin</code> can be used to provided the hint for the <code>lks</code> (current entity) index and <code>rightIndex</code>
element can be used to provided the <code>rks</code> (associated entity) index.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hash_join_hint">Hash Join Hint</h4>
<div class="paragraph">
<p>If the join type is going to be hash join, the hash side can be specified for the <code>rks</code> (associated entity).
If the associated entity is on the build side, it can be specified as <code>HashSide.BUILD</code> else <code>HashSide.PROBE</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_keys_hint">Use Keys Hint</h4>
<div class="paragraph">
<p><code>keys</code> element on the <code>@N1qlJoin</code> annotation can be used to specify unique document keys to restrict the join key space.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase.caching">Caching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes additional support for caching and <code>@Cacheable</code>.</p>
</div>
<div class="sect2">
<h3 id="caching.usage">Configuration &amp; Usage</h3>
<div class="paragraph">
<p>Technically, caching is not part of spring-data, but is implemented directly in the spring core. Most database implementations in the spring-data package can&#8217;t support <code>@Cacheable</code>, because it is not possible to store arbitrary data.</p>
</div>
<div class="paragraph">
<p>Couchbase supports both binary and JSON data, so you can get both out of the same database.</p>
</div>
<div class="paragraph">
<p>To make it work, you need to add the <code>@EnableCaching</code> annotation and configure the <code>cacheManager</code> bean:</p>
</div>
<div class="exampleblock">
<div class="title">Example 44. <code>AbstractCouchbaseConfiguration</code> for Caching</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
@EnableCaching
public class Config extends AbstractCouchbaseConfiguration {
    // general methods

  @Bean
  public CouchbaseCacheManager cacheManager(CouchbaseTemplate couchbaseTemplate) throws Exception {
  CouchbaseCacheManager.CouchbaseCacheManagerBuilder builder = CouchbaseCacheManager.CouchbaseCacheManagerBuilder
      .fromConnectionFactory(couchbaseTemplate.getCouchbaseClientFactory());
    builder.withCacheConfiguration("mySpringCache", CouchbaseCacheConfiguration.defaultCacheConfig());
    return builder.build();
  }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>persistent</code> identifier can then be used on the <code>@Cacheable</code> annotation to identify the cache manager to use (you can have more than one configured).</p>
</div>
<div class="paragraph">
<p>Once it is set up, you can annotate every method with the <code>@Cacheable</code> annotation to transparently cache it in your couchbase bucket. You can also customize how the key is generated.</p>
</div>
<div class="exampleblock">
<div class="title">Example 45. Caching example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Cacheable(value="persistent", key="'longrunsim-'+#time")
public String simulateLongRun(long time) {
    try {
        Thread.sleep(time);
    } catch(Exception ex) {
        System.out.println("This shouldnt happen...");
    }
    return "I've slept " + time + " miliseconds.;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you run the method multiple times, you&#8217;ll see a set operation happening first, followed by multiple get operations and no sleep time (which fakes the expensive execution). You can store whatever you want, if it is JSON of course you can access it through views and look at it in the Web UI.</p>
</div>
<div class="paragraph">
<p>Note that to use cache.clear() or catch.invalidate(), the bucket must have a primary key.
:leveloffset: -1</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix">Appendix</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved directive in index.adoc - include::../../../../spring-data-commons/src/main/asciidoc/repository-namespace-reference.adoc[]
Unresolved directive in index.adoc - include::../../../../spring-data-commons/src/main/asciidoc/repository-populator-namespace-reference.adoc[]
Unresolved directive in index.adoc - include::../../../../spring-data-commons/src/main/asciidoc/repository-query-keywords-reference.adoc[]
Unresolved directive in index.adoc - include::../../../../spring-data-commons/src/main/asciidoc/repository-query-return-types-reference.adoc[]
:leveloffset: -1</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version {version}<br>
Last updated 2022-07-14 13:35:52 -0700
</div>
</div>
</body>
</html>